---
title: "Análise Exploratória"
subtitle: Análise exploratória dos dados de duração do desemprego no Brasil para o biênio 2021-2022.
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE,warning=FALSE,message=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	fig.align = 'center',
	out.width = '80%'
)

```

## Fluxograma da elaboração do banco de dados.

O banco aqui analisado foi construído de acordo com o seguinte esquema, aplicado para cada indivíduo inicialmente em busca de trabalho na entrevista *t*:

```{r pressure, echo=FALSE, out.width = '80%',fig.align='center'}
knitr::include_graphics("flowchart_dados.png")
```

```{r message=FALSE, warning=FALSE}
# Bibliotecas
library(tidyverse)
library(data.table)
library(magrittr)
library(ggsurvfit)
library(readxl)
library(gmodels)
library(epitab)
library(cowplot)
library(ggpubr)

```


```{r}
### Carrega os dados gerados no script de manipulacao_banco_final
setwd("/home/lauratei/UNB/TCC/Code/tcc-code")
dados <- readRDS(file = "Dados-RDS/dados_sobrevivencia.rds")

```

```{r}
### Carregando dados do IVS

ivs <- readxl::read_xlsx("dados_ivs.xlsx",sheet = "Dados")
ivs$UF <- ivs$`Nome da UF`

dados <- left_join(dados,ivs[,c("UF","IVS","IVS Infraestrutura Urbana",
                                "IVS Capital Humano","IVS Renda e Trabalho")],by="UF")

dados$IVS <- as.numeric(dados$IVS)
dados$`IVS Capital Humano` <- as.numeric(dados$`IVS Capital Humano`)
dados$`IVS Infraestrutura Urbana` <- as.numeric(dados$`IVS Infraestrutura Urbana`)
dados$`IVS Renda e Trabalho` <- as.numeric(dados$`IVS Renda e Trabalho`)

## Indicando as faixas do IVS

dados <- dados %>% mutate(IVS_faixa = 
                            case_when(
                              IVS<0.2 ~ "Muito baixa",
                              IVS>=0.2 & IVS<0.3 ~ "Baixa",
                              IVS>=0.3 & IVS<0.4 ~ "Média",
                              IVS>=0.4 & IVS<0.5 ~ "Alta",
                              IVS>=0.5 ~ "Muito alta"
                            ),
                          IVS_faixa_infra = 
                            case_when(
                              `IVS Infraestrutura Urbana`<0.2 ~ "Muito baixa",
                              `IVS Infraestrutura Urbana`>=0.2 & `IVS Infraestrutura Urbana`<0.3 ~ "Baixa",
                              `IVS Infraestrutura Urbana`>=0.3 & `IVS Infraestrutura Urbana`<0.4 ~ "Média",
                              `IVS Infraestrutura Urbana`>=0.4 & `IVS Infraestrutura Urbana`<0.5 ~ "Alta",
                              `IVS Infraestrutura Urbana`>=0.5 ~ "Muito alta"
                            ),
                          IVS_faixa_humano = 
                            case_when(
                              `IVS Capital Humano`<0.2 ~ "Muito baixa",
                              `IVS Capital Humano`>=0.2 & `IVS Capital Humano`<0.3 ~ "Baixa",
                              `IVS Capital Humano`>=0.3 & `IVS Capital Humano`<0.4 ~ "Média",
                              `IVS Capital Humano`>=0.4 & `IVS Capital Humano`<0.5 ~ "Alta",
                              `IVS Capital Humano`>=0.5 ~ "Muito alta"
                              
                            ),
                          IVS_faixa_trabalho = 
                            case_when(
                              `IVS Renda e Trabalho`<0.2 ~ "Muito baixa",
                              `IVS Renda e Trabalho`>=0.2 & `IVS Renda e Trabalho`<0.3 ~ "Baixa",
                              `IVS Renda e Trabalho`>=0.3 & `IVS Renda e Trabalho`<0.4 ~ "Média",
                              `IVS Renda e Trabalho`>=0.4 & `IVS Renda e Trabalho`<0.5 ~ "Alta",
                              `IVS Renda e Trabalho`>=0.5 ~ "Muito alta"
                              
                            ))

# Transformando as faixas em fator

dados$IVS_faixa <- factor(dados$IVS_faixa, levels=c("Muito baixa","Baixa","Média"))

dados$IVS_faixa_humano <- factor(dados$IVS_faixa_humano, levels=c("Muito baixa","Baixa","Média"))

dados$IVS_faixa_infra <- factor(dados$IVS_faixa_infra, levels=c("Muito baixa","Baixa","Média","Alta"))

dados$IVS_faixa_trabalho <- factor(dados$IVS_faixa_trabalho, levels=c("Muito baixa","Baixa","Média","Alta"))

```



```{r}
### Criando variavel de Regiao

ufs_norte <- c("Acre","Amapá","Amazonas","Pará","Rondônia","Roraima",
               "Tocantins")

ufs_nordeste <- c("Alagoas","Bahia","Ceará","Maranhão","Paraíba",
                  "Pernambuco","Piauí","Rio Grande do Norte",
                  "Sergipe")

ufs_centro_oeste <- c("Distrito Federal","Goiás","Mato Grosso",
                     "Mato Grosso do Sul")

ufs_sudeste <- c("Espírito Santo","Minas Gerais","Rio de Janeiro",
                 "São Paulo")

ufs_sul <- c("Paraná","Rio Grande do Sul","Santa Catarina")

dados <- dados %>% mutate(regiao =
  case_when(
    UF %in% ufs_norte ~ "Norte",
    UF %in% ufs_nordeste ~ "Nordeste",
    UF %in% ufs_centro_oeste ~ "Centro-Oeste",
    UF %in% ufs_sudeste ~ "Sudeste",
    UF %in% ufs_sul ~ "Sul"))

```

```{r}
### Criando variavel de faixa etaria

# histograma das idades
#hist(dados$V2009)
#sum(dados$V2009>=14 & dados$V2009<=20)
#sum(dados$V2009>=21 & dados$V2009<=30)
#sum(dados$V2009>=31 & dados$V2009<=40)
#sum(dados$V2009>=41 & dados$V2009<=50)
#sum(dados$V2009>=51 & dados$V2009<=70)

faixa1 <- 14:20
faixa2 <- 21:30
faixa3 <- 31:40
faixa4 <- 41:50
faixa5 <- 51:70

dados <- dados %>% mutate(faixa_etaria =
  case_when(
    V2009 %in% faixa1 ~ paste(min(faixa1),"a",max(faixa1),"anos"),
    V2009 %in% faixa2 ~ paste(min(faixa2),"a",max(faixa2),"anos"),
    V2009 %in% faixa3 ~ paste(min(faixa3),"a",max(faixa3),"anos"),
    V2009 %in% faixa4 ~ paste(min(faixa4),"a",max(faixa4),"anos"),
    V2009 %in% faixa5 ~ paste(min(faixa5),"a",max(faixa5),"anos")
    )
  )

```

## Paleta de Cores

```{r, out.width = '50%',fig.align='left'}
### Criar tema de todos os gráficos e vetor de cores

tema <- theme_bw() +
theme(axis.title.y=element_text(colour="black", size=12),
axis.title.x = element_text(colour="black", size=12),
axis.text = element_text(colour = "black", size=12),
panel.border = element_blank(),
axis.line = element_line(colour = "darkgray"),
plot.title = element_text(hjust = 0.5, size=13),
legend.text=element_text(size=10))


vetor_cores <- c("#0f4c5c","#e36414","#ffb726","#9a031e","#5f0f40","#0f5f4e")


cores <- data.frame("type"=LETTERS[1:6],"val"=1,"col"=vetor_cores)

ggplot(cores,aes(x=type))+geom_bar(fill=cores$col)+
tema +
  coord_flip()

```


```{r}
### Proporcao de censura

#table(dados$censura_text)
#table(dados$censura_text)/nrow(dados)

prop_censura <- data.frame("Censurado"="55827 (64,89%)",
                           "Observado"="30209 (35,11%)")


knitr::kable(prop_censura, align = "c")

```

```{r}
### Proporcao das causas
dados$causa2 <- dados$causa
dados$causa2[is.na(dados$causa2)]<- "censurado"

#table(dados$causa2)
#table(dados$causa2)/nrow(dados)

prop_censura <- data.frame("Censurado"="55827 (64,89%)",
                           "Emprego informal"="14779 (17,18%)",
                           "Emprego formal"="7981 (9,28%)",
                           "Inatividade"="7449 (8,66%)",check.names = F)


knitr::kable(prop_censura, align = "c")
```


## Tabela geral das frequências das covariáveis

```{r}

dados$all <- factor(".",levels=c("."))
dados$faixa_etaria <- factor(dados$faixa_etaria,levels=c(paste(min(faixa1),"a",max(faixa1),"anos"),paste(min(faixa2),"a",max(faixa2),"anos"),paste(min(faixa3),"a",max(faixa3),"anos"),paste(min(faixa4),"a",max(faixa4),"anos"),paste(min(faixa5),"a",max(faixa5),"anos")))
dados$regiao <- factor(dados$regiao,levels=c("Norte","Nordeste","Sudeste",
                                             "Sul","Centro-Oeste"))
dados$Ano <- factor(dados$Ano,levels=c("2021","2022"))

tabela1 <- contingency_table(
  outcomes = list("All"="all"),
  independents = list("Sexo"="V2007","Raça/Cor"="V2010",
                      "Idade"="faixa_etaria","Escolaridade"="VD3006",
                      "Ano"="Ano",
                      "Posição no domicílio"="VD2002",
                      "Região"="regiao",
                      "IVS infraestrutura urbana"="IVS_faixa_infra"),
  crosstab_funcs = list(freq(digits = 4)),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=dados) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências das covariáveis"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")

tabela1
```


## Causas de saída do desemprego por variáveis sociodemográficas



```{r}
### Proporcao das causas de saida do desemprego VS var sociodemograficas

# sexo e cor vs causa de saida
tbl_contingencia<-dados %>% filter(!is.na(causa))
tbl_contingencia$causa <- factor(tbl_contingencia$causa,levels=c("emprego formal","emprego informal","inatividade"))
tbl_contingencia$V2007 <-factor(tbl_contingencia$V2007, levels=c("Homem","Mulher"))
tbl_contingencia$V2010 <- factor(tbl_contingencia$V2010,levels=c("Branca",
                                                           "Preta","Amarela",
                                                           "Parda","Indígena"))


contingency_table(
  independents = list("Saída do desemprego"="causa"),
  outcomes = list("Sexo"="V2007","Cor ou raça"="V2010"),
  crosstab_funcs = list(freq()),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de saída do desemprego por sexo e raça/cor"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")

```

```{r}
# escolaridade vs causa de saida
tbl_contingencia$regiao <-factor(tbl_contingencia$regiao, levels=c("Centro-Oeste","Nordeste","Norte",
"Sudeste","Sul"))


contingency_table(
  independents = list("Saída do desemprego"="causa"),
  outcomes = list("Região"="regiao"),
  crosstab_funcs = list(freq()),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de saída do desemprego por região"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")
```


```{r}
# regiao vs causa de saida
tbl_contingencia$VD3006 <-factor(tbl_contingencia$VD3006, levels=c("Sem instrução e menos de 1 ano de estudo","1 a 4 anos de estudo","5 a 8 anos de estudo",
"9 a 11 anos de estudo","12 a 15 anos de estudo","16 anos ou mais de estudo"))



contingency_table(
  independents = list("Saída do desemprego"="causa"),
  outcomes = list("Escolaridade"="VD3006"),
  crosstab_funcs = list(freq()),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de saída do desemprego por escolaridade"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")
```


```{r}
# faixa etaria vs causa de saida
tbl_contingencia$faixa_etaria <-factor(tbl_contingencia$faixa_etaria, levels=c(paste(min(faixa1),"a",max(faixa1),"anos"),                                              paste(min(faixa2),"a",max(faixa2),"anos"),                            paste(min(faixa3),"a",max(faixa3),"anos"),paste(min(faixa4),"a",max(faixa4),"anos"),paste(min(faixa5),"a",max(faixa5),"anos")))



contingency_table(
  independents = list("Saída do desemprego"="causa"),
  outcomes = list("Faixa etária"="faixa_etaria"),
  crosstab_funcs = list(freq()),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de saída do desemprego por faixa etária"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")

```

```{r}
# ano (inicial) vs causa de saida

tbl_contingencia$Ano <-factor(tbl_contingencia$Ano, levels=c("2021","2022"))



contingency_table(
  independents = list("Saída do desemprego"="causa"),
  outcomes = list("Ano"="Ano"),
  crosstab_funcs = list(freq()),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de saída do desemprego por ano"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")
```

```{r}
# todas as vars vs causa de saida

# variaveis nas linhas (corrigir as porcentagens!!!)

tabela2 <- contingency_table(
  independents = list("Sexo"="V2007","Cor ou raça"="V2010",
                      "Região"="regiao","Escolaridade"="VD3006",
                      "Ano"="Ano","Posição no domicílio"="VD2002","Faixa etária"="faixa_etaria",
                      "IVS infraestrutura urbana"="IVS_faixa_infra") ,
  outcomes = list("Saída do desemprego"="causa"),
  crosstab_funcs = list(freq()),
  #row_funcs = list("Odds"=odds_ratio("V2007")),
  data=tbl_contingencia) %>%
  neat_table(
    format = 'latex',
    booktabs=TRUE,
    caption="Frequências de saída do desemprego por variáveis sociodemográficas"
  ) %>%
  kableExtra::kable_classic(latex_options = "HOLD_position")

tabela2
```


## Curvas de Sobrevivência estimadas - Kaplan Meier

```{r}
## Limites dos graficos (eixo x)

lim <- c(0,150)

```


```{r}
### Curva geral de sobrevivencia estimada

survfit2(Surv(tempo, censura) ~ 1, data = dados) %>% 
  ggsurvfit(color=vetor_cores[1]) +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema

```

```{r}
### Estimativa da media e mediana do tempo de desemprego
# mediana
survfit2(Surv(tempo, censura) ~ 1, data = dados)

```

```{r}
# media


```


```{r}
### Curva de sobrevivencia por sexo estimada
survfit2(Surv(tempo, censura) ~ V2007, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=c(Homem=vetor_cores[1],Mulher=vetor_cores[2]))+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_color_manual(values=c(vetor_cores[1], vetor_cores[2])) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema
```

```{r}
### Curva de sobrevivencia por idade estimada

colors_fill <- c("14 a 20 anos"=vetor_cores[1],
                 "21 a 30 anos"=vetor_cores[2],
                 "31 a 40 anos"=vetor_cores[3],
                 "41 a 50 anos"=vetor_cores[4],
                 "51 a 70 anos"=vetor_cores[5])


survfit2(Surv(tempo, censura) ~ faixa_etaria, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_fill_manual(values=colors_fill)+
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema
```

```{r}
### Curva de sobrevivencia por raca/cor estimada

colors_fill <- c("Branca"=vetor_cores[1],
                 "Preta"=vetor_cores[2],
                 "Amarela"=vetor_cores[3],
                 "Parda"=vetor_cores[4],
                 "Indígena"=vetor_cores[5])

survfit2(Surv(tempo, censura) ~ V2010, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_fill_manual(values=colors_fill)+
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema
```

Retirando amarelos e indígenas

```{r}
### Curva de sobrevivencia por raca/cor estimada

colors_fill <- c("Branca"=vetor_cores[1],
                 "Preta"=vetor_cores[2],
                 "Parda"=vetor_cores[3])

dados_tmp <- dados %>% filter(V2010 %in% c("Branca","Preta","Parda"))

survfit2(Surv(tempo, censura) ~ V2010, data = dados_tmp) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_fill_manual(values=colors_fill)+
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema
```


```{r}
brancos <- c("Branca","Amarela")

dados <- dados %>% mutate(cor = case_when(
  V2010 %in% brancos ~ "Branca",
  !(V2010 %in% brancos) ~ "Não branca",
))

```

**Branca = Brancos+Amarelos**

**Não branca = Pretos+Pardos+Indígenas**

```{r}
### Curva de sobrevivencia por raca/cor estimada

colors_fill <- c("Branca"=vetor_cores[1],
                 "Não branca"=vetor_cores[2]
                 )


survfit2(Surv(tempo, censura) ~ cor, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema

```

```{r}
### Curva de sobrevivencia por sexo e raca/cor estimada

dados <- dados %>% mutate(sexo_cor = 
                          case_when(
                          V2007=="Homem" & cor=="Branca" ~ "Homem branco",
                          V2007=="Homem" & cor=="Não branca" ~ "Homem não branco",
                          V2007=="Mulher" & cor=="Branca" ~ "Mulher branca",
                          V2007=="Mulher" & cor=="Não branca" ~ "Mulher não branca",
                            ))

colors_fill <- c("Homem branco"=vetor_cores[1],
                 "Homem não branco"=vetor_cores[2],
                 "Mulher branca"=vetor_cores[3],
                 "Mulher não branca"=vetor_cores[4])

survfit2(Surv(tempo, censura) ~ sexo_cor, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill)+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(c(0,150)) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema +
  theme(legend.position = 'top', legend.direction = "horizontal")

```

```{r}
### Curva de sobrevivencia por regiao estimada

colors_fill <- c("Centro-Oeste"=vetor_cores[1],
                 "Nordeste"=vetor_cores[2],
                 "Norte"=vetor_cores[3],
                 "Sudeste"=vetor_cores[4],
                 "Sul"=vetor_cores[5]
                 )

survfit2(Surv(tempo, censura) ~ regiao, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema
```

```{r}
### Curva de sobrevivencia por escolaridade estimada

colors_fill <- c("Sem instrução e menos de 1 ano de estudo"=vetor_cores[1],
                 "1 a 4 anos de estudo"=vetor_cores[2],
                 "5 a 8 anos de estudo"=vetor_cores[3],
                 "9 a 11 anos de estudo"=vetor_cores[4],
                 "12 a 15 anos de estudo"=vetor_cores[5],
                 "16 anos ou mais de estudo"=vetor_cores[6]
                 )

survfit2(Surv(tempo, censura) ~ VD3006, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema +
  theme(legend.position = 'top', legend.direction = "horizontal")
```



```{r}
### Curva de sobrevivencia por posicao no domicílio estimada

posicoes_principais <- c("Pessoa responsável","Cônjuge ou companheiro(a)",
                         "Filho(a)")

dados <- dados %>% mutate(posicao_domicilio = 
                        case_when(
                        VD2002 == "Pessoa responsável" ~ "Pessoa responsável",
                        VD2002 == "Cônjuge ou companheiro(a)" ~ "Cônjuge ou companheiro(a)",
                        VD2002 == "Filho(a)" ~ "Filho(a)",
                        !(VD2002 %in% posicoes_principais) ~ "Outros",
                          )
                        )

table(dados$posicao_domicilio)

colors_fill <- c("Cônjuge ou companheiro(a)"=vetor_cores[1],
                 "Filho(a)"=vetor_cores[2],
                 "Outros"=vetor_cores[3],
                 "Pessoa responsável"=vetor_cores[4])

survfit2(Surv(tempo, censura) ~ posicao_domicilio, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill)+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema +
  theme(legend.position = 'top', legend.direction = "horizontal")



```

## Curvas de Sobrevivência por Índice de Vulnerabilidade Social (IVS) da UF

```{r, echo=FALSE, out.width = '80%',fig.align='center'}
knitr::include_graphics("infograficos_ivs.jpg")
```

### IVS geral

```{r}
### Curva de sobrevivencia por faixa do IVS estimada

colors_fill <- c("Muito baixa"=vetor_cores[1],
                 "Baixa"=vetor_cores[2],
                 "Média"=vetor_cores[3]
                 )

survfit2(Surv(tempo, censura) ~ IVS_faixa, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill)+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema

```

### IVS dimensão infraestrutura urbana (coleta de lixo, água e esgoto inadequados, tempo de deslocamento casa-trabalho)

```{r}
### Curva de sobrevivencia por faixa do IVS (infra urbana) estimada

colors_fill <- c("Muito baixa"=vetor_cores[1],
                 "Baixa"=vetor_cores[2],
                 "Média"=vetor_cores[3],
                 "Alta"=vetor_cores[4]
                 )

survfit2(Surv(tempo, censura) ~ IVS_faixa_infra, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill)+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema

```

### IVS dimensão capital humano (mortalidade infantil, crianças de 0 a 5 fora da escola, não estudam e não trabalham e baixa renda, crianças de 6 a 14 fora da escola, mães jovens (10 a 17), mães sem fundamental+filhos até 15, analfabetismo, crianças em domicílio em que ninguém tem o fundamental completo)

```{r}
### Curva de sobrevivencia por faixa do IVS (capital humano) estimada

colors_fill <- c("Muito baixa"=vetor_cores[1],
                 "Baixa"=vetor_cores[2],
                 "Média"=vetor_cores[3]
                 )

survfit2(Surv(tempo, censura) ~ IVS_faixa_humano, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill)+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema

```

### IVS dimensão renda e trabalho (renda menor ou igual a R$255, baixa renda e dependente de idosos, desocupação, trabalho infantil, ocupação informal sem ensino fundamental)

```{r}
### Curva de sobrevivencia por faixa do IVS (renda e trabalho) estimada

colors_fill <- c("Muito baixa"=vetor_cores[1],
                 "Baixa"=vetor_cores[2],
                 "Média"=vetor_cores[3],
                 "Alta"=vetor_cores[4]
                 )

survfit2(Surv(tempo, censura) ~ IVS_faixa_trabalho, data = dados) %>% 
  ggsurvfit() +
  add_confidence_interval() +
  scale_fill_manual(values=colors_fill)+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  scale_color_manual(values=colors_fill) +
  labs(
    x = "Meses",
    y = "Probabilidade de sobrevivência"
  )+ tema 
```

```{r}
causa <- dados %>% filter(!is.na(causa))
censurado <- dados %>% filter(is.na(causa))

#summary(causa$tempo)
#summary(censurado$tempo)
```

## Curvas de Sobrevivência estimadas - discriminado pelas 3 causas


```{r}
### Curva geral de sobrevivencia estimada

## Emprego formal

emprego_formal_df <- dados
#censurando causas diferentes de emprego formal
emprego_formal_df$censura[emprego_formal_df$causa!="emprego formal"] <- 0
#porcentagem de censuras
sum(emprego_formal_df$censura==0)/nrow(emprego_formal_df)

s_formal <- survfit2(Surv(tempo, censura) ~ 1, data = emprego_formal_df) %>% 
  ggsurvfit(color=vetor_cores[1]) +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  ylim(c(0,1)) +
  labs(
    x = "Meses",
    y = "S(t)",
    title = "Emprego formal"
  )+ tema


```

```{r}
## Emprego informal

emprego_informal_df <- dados
#censurando causas diferentes de emprego informal
emprego_informal_df$censura[emprego_informal_df$causa!="emprego informal"] <- 0
#porcentagem de censuras
sum(emprego_informal_df$censura==0)/nrow(emprego_informal_df)

s_informal <- survfit2(Surv(tempo, censura) ~ 1, data = emprego_informal_df) %>% 
  ggsurvfit(color=vetor_cores[1]) +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  ylim(c(0,1)) +
  labs(
    x = "Meses",
    y = "S(t)",
    title = "Emprego informal"
  )+ tema
```


```{r}
## Inatividade

inatividade_df <- dados
#censurando causas diferentes de inatividade
inatividade_df$censura[inatividade_df$causa!="inatividade"] <- 0
#porcentagem de censuras
sum(inatividade_df$censura==0)/nrow(inatividade_df)

s_inativ <- survfit2(Surv(tempo, censura) ~ 1, data = inatividade_df) %>% 
  ggsurvfit(color=vetor_cores[1]) +
  add_confidence_interval() +
  scale_x_continuous(breaks=seq(0,500,by=50))+
  xlim(lim) +
  ylim(c(0,1)) +
  labs(
    x = "Meses",
    y = "S(t)",
    title = "Inatividade"
  )+ tema


### Painel geral

cowplot::plot_grid(s_formal,s_informal,s_inativ,nrow=2)
ggsave("St_geral.png",width=178,height=103, units = "mm") 
```

```{r}
## Curva geral de sobrevivencia estimada (sobreposta)
colors_fill <- c("Emprego formal    "=vetor_cores[1],
                 "Emprego informal    "=vetor_cores[2],
                 "Inatividade"=vetor_cores[3]
                 )
# emprego formal
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = emprego_formal_df)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = emprego_informal_df)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = inatividade_df)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_geral <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

ggsave("St_geral2.png",width = 168, height = 103, units = "mm") 

```


```{r}
### Curva sobrevivencia por sexo - 3 causas

## Homens
colors_fill <- c("Emprego formal    "=vetor_cores[1],
                 "Emprego informal    "=vetor_cores[2],
                 "Inatividade"=vetor_cores[3]
                 )
# emprego formal

homem_formal <- emprego_formal_df %>% filter(V2007=="Homem")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = homem_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

homem_informal <- emprego_informal_df %>% filter(V2007=="Homem")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = homem_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

homem_inativ <- inatividade_df %>% filter(V2007=="Homem")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = homem_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_homem <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Homens")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 

```

```{r}
## Mulheres

# emprego formal

mulher_formal <- emprego_formal_df %>% filter(V2007=="Mulher")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = mulher_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

mulher_informal <- emprego_informal_df %>% filter(V2007=="Mulher")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = mulher_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

mulher_inativ <- inatividade_df %>% filter(V2007=="Mulher")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = mulher_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_mulher <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Mulheres")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

leg <- get_legend(plot_mulher)

plot_mulher <- plot_mulher + guides(colour="none")

# build grid without legends
pgrid <- plot_grid(plot_homem, plot_mulher,nrow = 1)
# add legend
grid_sexo <- plot_grid(leg, pgrid, nrow = 2, rel_heights = c(.15, 1))
grid_sexo

ggsave("St_sexo.png",width = 168, height = 93, units = "mm") 

```

```{r}
### Curva sobrevivencia por ano - 3 causas

## 2021

# emprego formal

formal_21 <- emprego_formal_df %>% filter(Ano=="2021")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = formal_21)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

informal_21 <- emprego_informal_df %>% filter(Ano=="2021")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = informal_21)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

inativ_21 <- inatividade_df %>% filter(Ano=="2021")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = inativ_21)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_21 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="2021")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## 2022

# emprego formal

formal_22 <- emprego_formal_df %>% filter(Ano=="2022")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = formal_22)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

informal_22 <- emprego_informal_df %>% filter(Ano=="2022")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = informal_22)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

inativ_22 <- inatividade_df %>% filter(Ano=="2022")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = inativ_22)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_22 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="2022")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

leg <- get_legend(plot_22)

plot_22 <- plot_22 + guides(colour="none")

# build grid without legends
pgrid <- plot_grid(plot_21, plot_22,nrow = 1)
# add legend
plot_grid(leg, pgrid, nrow = 2, rel_heights = c(.15, 1))

ggsave("St_ano.png",width = 168, height = 93, units = "mm") 

```

```{r}
### Curva sobrevivencia por raça/cor - 3 causas

## Brancos

# emprego formal

branco_formal <- emprego_formal_df %>% filter(cor=="Branca")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = branco_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

branco_informal <- emprego_informal_df %>% filter(cor=="Branca")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = branco_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

branco_inativ <- inatividade_df %>% filter(cor=="Branca")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = branco_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_branco <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Brancos")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 

```

```{r}
## Nao brancos

# emprego formal

nbranco_formal <- emprego_formal_df %>% filter(cor=="Não branca")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = nbranco_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

nbranco_informal <- emprego_informal_df %>% filter(cor=="Não branca")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = nbranco_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

nbranco_inativ <- inatividade_df %>% filter(cor=="Não branca")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = nbranco_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_nbranco <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Não brancos")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

leg <- get_legend(plot_nbranco)

plot_nbranco <- plot_nbranco + guides(colour="none")

# build grid without legends
pgrid <- plot_grid(plot_branco, plot_nbranco, nrow = 1)
# add legend
grid_cor <- plot_grid(leg, pgrid, nrow = 2, rel_heights = c(.15, 1))
grid_cor

ggsave("St_cor.png",width = 168, height = 93, units = "mm") 

```
```{r}
### Curva sobrevivencia por IVS infra urbana - 3 causas

## IVS muito baixa/baixa

# emprego formal

IVSbaixo_formal <- emprego_formal_df %>% filter(IVS_faixa_infra %in% c("Muito baixa","Baixa"))
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = IVSbaixo_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

IVSbaixo_informal <- emprego_informal_df %>% filter(IVS_faixa_infra %in% c("Muito baixa","Baixa"))
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = IVSbaixo_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

IVSbaixo_inativ <- inatividade_df %>% filter(IVS_faixa_infra %in% c("Muito baixa","Baixa"))
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = IVSbaixo_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_IVSbaixo <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Infraestrutura urbana baixa")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## IVS infra urbana média/alta

# emprego formal

IVSalto_formal <- emprego_formal_df %>% filter(IVS_faixa_infra %in% c("Média","Alta"))
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = IVSalto_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

IVSalto_informal <- emprego_informal_df %>% filter(IVS_faixa_infra %in% c("Média","Alta"))
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = IVSalto_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

IVSalto_inativ <- inatividade_df %>% filter(IVS_faixa_infra %in% c("Média","Alta"))
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = IVSalto_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_IVSalto <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Infraestrutura urbana alta")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

leg <- get_legend(plot_IVSalto)

plot_IVSalto <- plot_IVSalto + guides(colour="none")

# build grid without legends
pgrid <- plot_grid(plot_IVSalto, plot_IVSbaixo, nrow = 1)
# add legend
plot_grid(leg, pgrid, nrow = 2, rel_heights = c(.15, 1))

ggsave("St_IVS.png",width = 168, height = 93, units = "mm") 
```

```{r}
### Curva sobrevivencia por posicao no domicilio - 3 causas

## Responsavel pelo domicilio

# emprego formal

responsavel_formal <- emprego_formal_df %>% filter(posicao_domicilio == "Pessoa responsável")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = responsavel_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

responsavel_informal <- emprego_informal_df %>% filter(posicao_domicilio == "Pessoa responsável")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = responsavel_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

responsavel_inativ <- inatividade_df %>% filter(posicao_domicilio == "Pessoa responsável")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = responsavel_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_responsavel <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Pessoa responsável")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## Cônjuge ou companheiro(a)

# emprego formal

conjuge_formal <- emprego_formal_df %>% filter(posicao_domicilio == "Cônjuge ou companheiro(a)")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = conjuge_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

conjuge_informal <- emprego_informal_df %>% filter(posicao_domicilio == "Cônjuge ou companheiro(a)")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = conjuge_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

conjuge_inativ <- inatividade_df %>% filter(posicao_domicilio == "Cônjuge ou companheiro(a)")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = conjuge_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_conjuge <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Cônjuge ou companheiro(a)")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## Filho(a)

# emprego formal

filho_formal <- emprego_formal_df %>% filter(posicao_domicilio == "Filho(a)")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = filho_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

filho_informal <- emprego_informal_df %>% filter(posicao_domicilio == "Filho(a)")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = filho_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

filho_inativ <- inatividade_df %>% filter(posicao_domicilio == "Filho(a)")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = filho_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_filho <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Filho(a)")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## pos no domicilio: Outros

# emprego formal

outros_formal <- emprego_formal_df %>% filter(posicao_domicilio == "Outros")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = outros_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

outros_informal <- emprego_informal_df %>% filter(posicao_domicilio == "Outros")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = outros_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

outros_inativ <- inatividade_df %>% filter(posicao_domicilio == "Outros")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = outros_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_outros <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Outros")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

leg <- get_legend(plot_outros)

plot_outros <- plot_outros + guides(colour="none")

# build grid without legends
pgrid <- plot_grid(plot_responsavel,plot_conjuge, plot_filho, plot_outros, nrow = 2)
# add legend
grid_posicao <- plot_grid(leg, pgrid, nrow = 2, rel_heights = c(.10, 1))
grid_posicao

#ggsave("St_posicao_domicilio.png",width = 178, height = 123, units = "mm") 
```
```{r}
### Curva sobrevivencia por anos de estudo - 3 causas

## Sem instrução e menos de 1 ano de estudo

# emprego formal

sinstrucao_formal <- emprego_formal_df %>% filter(VD3006 == "Sem instrução e menos de 1 ano de estudo")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = sinstrucao_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

sinstrucao_informal <- emprego_informal_df %>% filter(VD3006 == "Sem instrução e menos de 1 ano de estudo")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = sinstrucao_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

sinstrucao_inativ <- inatividade_df %>% filter(VD3006 == "Sem instrução e menos de 1 ano de estudo")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = sinstrucao_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_sinstrucao <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="Sem instrução e menos de 1 ano")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## 1 a 4 anos de estudo

# emprego formal

ate4_formal <- emprego_formal_df %>% filter(VD3006 == "1 a 4 anos de estudo")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = ate4_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

ate4_informal <- emprego_informal_df %>% filter(VD3006 == "1 a 4 anos de estudo")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = ate4_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

ate4_inativ <- inatividade_df %>% filter(VD3006 == "1 a 4 anos de estudo")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = ate4_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_ate4 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="1 a 4 anos de estudo")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## 5 a 8 anos de estudo

# emprego formal

ate8_formal <- emprego_formal_df %>% filter(VD3006 == "5 a 8 anos de estudo")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = ate8_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

ate8_informal <- emprego_informal_df %>% filter(VD3006 == "5 a 8 anos de estudo")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = ate8_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

ate8_inativ <- inatividade_df %>% filter(VD3006 == "5 a 8 anos de estudo")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = ate8_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_ate8 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="5 a 8 anos de estudo")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## 9 a 11 anos de estudo

# emprego formal

ate11_formal <- emprego_formal_df %>% filter(VD3006 == "9 a 11 anos de estudo")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = ate11_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

ate11_informal <- emprego_informal_df %>% filter(VD3006 == "9 a 11 anos de estudo")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = ate11_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

ate11_inativ <- inatividade_df %>% filter(VD3006 == "9 a 11 anos de estudo")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = ate11_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_ate11 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="9 a 11 anos de estudo")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```


```{r}
## 12 a 15 anos de estudo

# emprego formal

ate15_formal <- emprego_formal_df %>% filter(VD3006 == "12 a 15 anos de estudo")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = ate15_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

ate15_informal <- emprego_informal_df %>% filter(VD3006 == "12 a 15 anos de estudo")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = ate15_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

ate15_inativ <- inatividade_df %>% filter(VD3006 == "12 a 15 anos de estudo")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = ate15_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_ate15 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="12 a 15 anos de estudo")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + guides(colour="none") 
```

```{r}
## 16 anos ou mais de estudo

# emprego formal

ate16_formal <- emprego_formal_df %>% filter(VD3006 == "16 anos ou mais de estudo")
fit1 <- survfit2(Surv(tempo, censura) ~ 1, data = ate16_formal)
df <- data.frame(tempo=fit1$time,surv=fit1$surv,Causa="Emprego formal    ")

# emprego informal

ate16_informal <- emprego_informal_df %>% filter(VD3006 == "16 anos ou mais de estudo")
fit2 <- survfit2(Surv(tempo, censura) ~ 1, data = ate16_informal)
df2 <- data.frame(tempo=fit2$time,surv=fit2$surv,Causa="Emprego informal    ")

# inatividade

ate16_inativ <- inatividade_df %>% filter(VD3006 == "16 anos ou mais de estudo")
fit3 <- survfit2(Surv(tempo, censura) ~ 1, data = ate16_inativ)
df3 <- data.frame(tempo=fit3$time,surv=fit3$surv,Causa="Inatividade")

merged_df <- rbind(df,df2,df3)

plot_ate16 <- ggplot(merged_df,aes(x=tempo,y=surv,colour=Causa))+
geom_step()+
labs(x="Meses",y="S(t)",title="16 anos ou mais de estudo")+
  scale_x_continuous(breaks=seq(0,500,by=50))+
  scale_fill_manual(values=colors_fill) +
  scale_color_manual(values=colors_fill) +
  xlim(lim) +
  ylim(c(0,1)) +
tema + theme(legend.title = element_blank()) + theme(legend.position = 'top', legend.direction = "horizontal")

leg <- get_legend(plot_ate16)

plot_ate16 <- plot_ate16 + guides(colour="none")

# build grid without legends
pgrid <- plot_grid(plot_sinstrucao,plot_ate4,plot_ate8,plot_ate11,plot_ate15,plot_ate16, nrow = 3)
# add legend
plot_grid(leg, pgrid, nrow = 2, rel_heights = c(0.075, 1))

ggsave("St_escolaridade.png",width = 210, height = 287, units = "mm") 
```

```{r}
### Juntando os graficos mais interessantes em 1 painel

# Sexo + Cor + Posicao no domicilio

# build grid without legends
pgrid <- plot_grid(plot_responsavel,plot_conjuge, nrow = 1)
# add legend
grid_pos1 <- plot_grid(leg, pgrid, nrow = 2, rel_heights = c(.15, 1))

pgrid2 <- plot_grid(plot_filho,plot_outros,nrow=1)

plot_grid(grid_sexo, grid_cor, grid_pos1 ,pgrid2, nrow = 4,
          rel_heights = c(1, 1, 1, 1))

ggsave("St_painel1.png",width = 210, height = 287, units = "mm") 

```

```{r}
### Teste qui-quadrado para as tabelas 2x2

# Saida do desemprego por sexo

freqs <- dados %$% tapply(causa,V2007,table)

tbl_quiquadrado <- as.table(rbind(freqs$Homem, freqs$Mulher))
dimnames(tbl_quiquadrado) <- list(sexo = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_sexo <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por raça/cor

freqs <- dados %$% tapply(causa,V2010,table)

tbl_quiquadrado <- as.table(rbind(freqs$Branca, freqs$Preta,
                                  freqs$Amarela, freqs$Parda,freqs$Indígena))
dimnames(tbl_quiquadrado) <- list(cor = names(freqs)[-6],
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_cor <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por regiao

freqs <- dados %$% tapply(causa,regiao,table)

tbl_quiquadrado <- as.table(rbind(freqs$Norte, freqs$Nordeste,
                                  freqs$Sudeste, freqs$Sul,
                                  freqs$`Centro-Oeste`))
dimnames(tbl_quiquadrado) <- list(regiao = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_regiao <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por posicao no domicilio

freqs <- dados %$% tapply(causa,posicao_domicilio,table)

tbl_quiquadrado <- as.table(rbind(freqs$`Cônjuge ou companheiro(a)`, freqs$`Filho(a)`,freqs$Outros, freqs$`Pessoa responsável`))

dimnames(tbl_quiquadrado) <- list(posicao_domicilio = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_posicao <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por escolaridade

freqs <- dados %$% tapply(causa,VD3006,table)

tbl_quiquadrado <- as.table(rbind(freqs$`Sem instrução e menos de 1 ano de estudo`, freqs$`1 a 4 anos de estudo`,freqs$`5 a 8 anos de estudo`, freqs$`9 a 11 anos de estudo`,freqs$`12 a 15 anos de estudo`,freqs$`16 anos ou mais de estudo`))

dimnames(tbl_quiquadrado) <- list(escolaridade = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_escolaridade <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por ano

freqs <- dados %$% tapply(causa,Ano,table)

tbl_quiquadrado <- as.table(rbind(freqs$`2021`,freqs$`2022`))

dimnames(tbl_quiquadrado) <- list(ano = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_ano <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por faixa etaria

freqs <- dados %$% tapply(causa,faixa_etaria,table)

tbl_quiquadrado <- as.table(rbind(freqs$`14 a 20 anos`,freqs$`21 a 30 anos`,
                                  freqs$`31 a 40 anos`,freqs$`41 a 50 anos`,
                                  freqs$`51 a 70 anos`))

dimnames(tbl_quiquadrado) <- list(idade = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_idade <- chisq.test(tbl_quiquadrado))

# Saida do desemprego por IVS infra urbana

freqs <- dados %$% tapply(causa,IVS_faixa_infra,table)

tbl_quiquadrado <- as.table(rbind(freqs$`Muito baixa`,freqs$Baixa,
                                  freqs$Média,freqs$Alta))

dimnames(tbl_quiquadrado) <- list(IVS = names(freqs),
                    causa = dimnames(tbl_quiquadrado)[[2]])

(Xsq_IVS <- chisq.test(tbl_quiquadrado))


```

```{r}
### Montando tabela com os resultados dos testes
### Qui-Quadrado


x_squared <- c(Xsq_sexo$statistic,Xsq_cor$statistic,
               Xsq_regiao$statistic,
               Xsq_posicao$statistic,Xsq_escolaridade$statistic,
               Xsq_ano$statistic,Xsq_idade$statistic,
               Xsq_IVS$statistic)


graus_liberdade <- c(Xsq_sexo$parameter,Xsq_cor$parameter,
               Xsq_regiao$parameter,
               Xsq_posicao$parameter,Xsq_escolaridade$parameter,
               Xsq_ano$parameter,Xsq_idade$parameter,
               Xsq_IVS$parameter)

p_valores <- c(Xsq_sexo$p.value,Xsq_cor$p.value,
               Xsq_regiao$p.value,
               Xsq_posicao$p.value,Xsq_escolaridade$p.value,
               Xsq_ano$p.value,Xsq_idade$p.value,
               Xsq_IVS$p.value)


vars <- c("Sexo","Raça/Cor","Região","Posição no domicílio",
          "Escolaridade","Ano","Faixa etária","IVS infraestrutura urbana")

df_qui_quadrado <- data.frame("Covariável"=vars,
                              "Estatística do teste"=round(x_squared,3),
                              "Graus de liberdade"=graus_liberdade,
                              "P-valor"=p_valores,
                              "<0,001"=p_valores<0.001,
                              check.names = F)

tbl_x2 <- df_qui_quadrado %>%
  kableExtra::kbl(.,digits=3,align=c('l','c','c','c','c'),booktabs = T,caption = 'Teste Qui-Quadrado de independência entre as covariáveis e a causa de saída do desemprego',format="latex") %>% 
  kableExtra::kable_classic(full_width=FALSE,latex_options = "HOLD_position")

```

